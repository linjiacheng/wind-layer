/*!
 * author: FDD <smileFDD@gmail.com> 
 * wind-layer v0.0.6
 * build-time: 2019-3-5 10:25
 * LICENSE: MIT
 * (c) 2017-2019 https://sakitam-fdd.github.io/wind-layer
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.windLayer=e()}(this,function(){"use strict";function n(t,e){t.prototype=Object.create(e.prototype),(t.prototype.constructor=t).__proto__=e}function a(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}var r=function(f){f.projection||(f.projection="EPSG:4326");var p,v,h,g,w,m,y,u,c,d=f.minVelocity||0,l=f.maxVelocity||10,e=(f.velocityScale||.005)*(Math.pow(window.devicePixelRatio,1/3)||1),M=Math.floor(102),x=f.particleAge||90,_=f.lineWidth||1,b=f.particleMultiplier||1/300,C=Math.pow(window.devicePixelRatio,1/3)||1.6,E=1e3/(f.frameRate||15),D=f.colorScale||["rgb(36,104, 180)","rgb(60,157, 194)","rgb(128,205,193 )","rgb(151,218,168 )","rgb(198,231,181)","rgb(238,247,217)","rgb(255,238,159)","rgb(252,217,125)","rgb(255,182,100)","rgb(252,150,75)","rgb(250,112,52)","rgb(245,64,32)","rgb(237,45,28)","rgb(220,24,32)","rgb(180,0,35)"],W=f.overlayColorScale||[[193,[37,4,42]],[206,[41,10,130]],[219,[81,40,40]],[233.15,[192,37,149]],[255.372,[70,215,215]],[273.15,[21,84,187]],[275.15,[24,132,14]],[291,[247,251,59]],[298,[235,167,21]],[311,[230,71,39]],[328,[88,27,67]]],o=[NaN,NaN,null],r=f.data,z=!0,a=function(t,e,n,i,a,r){var o=1-t,s=1-e;return n*o*s+i*t*s+a*o*e+r*t*e},s=function(t,e,n,i,a,r){var o=1-t,s=1-e,h=o*s,u=t*s,c=o*e,d=t*e,l=n[0]*h+i[0]*u+a[0]*c+r[0]*d,f=n[1]*h+i[1]*u+a[1]*c+r[1]*d;return[l,f,Math.sqrt(l*l+f*f)]},P=function(t){var e=null,n=null,i=null;return t.forEach(function(t){switch(t.header.parameterCategory+","+t.header.parameterNumber){case"1,2":case"2,2":e=t;break;case"1,3":case"2,3":n=t;break;default:i=t}}),null!=i?function(t){z=!1;var e=t.data;return{header:t.header,interpolate:a,data:function(t){return e[t]}}}(i):function(t,e){z=!0;var n=t.data,i=e.data;return{header:t.header,data:function(t){return[n[t],i[t]]},interpolate:s}}(e,n)},S=function(t,e){if(!v)return null;var n,i=F(t-g,360)/m,a=(w-e)/y,r=Math.floor(i),o=r+1,s=Math.floor(a),h=s+1;if(n=v[s]){var u=n[r],c=n[o];if(I(u)&&I(c)&&(n=v[h])){var d=n[r],l=n[o];if(I(d)&&I(l))return p.interpolate(i-r,a-s,u,c,d,l)}}return null},I=function(t){return null!=t},F=function(t,e){return t-e*Math.floor(t/e)},N=function(t,e,n){return i=t,a=[e,n],(Math.max(a[0],Math.min(i,a[1]))-e)/(n-e);var i,a},n=function(t,e){var n=t[0],i=t[1],a=t[2],r=e[0]-n,o=e[1]-i,s=e[2]-a;return function(t,e){return[Math.floor(n+t*r),Math.floor(i+t*o),Math.floor(a+t*s),e]}};function j(t){for(var a=[],r=[],o=[],e=0;e<t.length-1;e++)a.push(t[e+1][0]),r.push(n(t[e][1],t[e+1][1])),o.push([t[e][0],t[e+1][0]]);return function(t,e){var n;for(n=0;n<a.length-1&&!(t<=a[n]);n++);var i=o[n];return r[n](N(t,i[0],i[1]),e)}}var A,B=function(t,e,n,i,a,r,o,s){var h=o[0]*r,u=o[1]*r,c=L(t,e,n,i,a,s);return o[0]=c[0]*h+c[2]*u,o[1]=c[1]*h+c[3]*u,o},L=function(t,e,n,i,a,r){var o=2*Math.PI,s="EPSG:4326"===f.projection?5:Math.pow(10,-5.2),h=e<0?s:-s,u=n<0?s:-s,c=k(n,e+h,r),d=k(n+u,e,r),l=Math.cos(n/360*o);return[(c[0]-i)/h/l,(c[1]-a)/h/l,(d[0]-i)/u,(d[1]-a)/u]},T=function(i,a,t,e){function r(t,e){var n=i[Math.round(t)];return n&&n[Math.round(e)]||o}r.release=function(){i=[]},r.randomize=function(t){for(var e,n,i=0;null===r(e=Math.round(Math.floor(Math.random()*a.width)+a.x),n=Math.round(Math.floor(Math.random()*a.height)+a.y))[2]&&i++<30;);return t.x=e,t.y=n,t},r.overlay=t.imageData,e(a,r)},R=function(t){return t/180*Math.PI},$=function(t){return t/(Math.PI/180)};A="EPSG:4326"===f.projection?function(t,e,n){var i=n.east-n.west,a=n.south-n.north,r=$(n.north)+e/n.height*$(a);return[$(n.west)+t/n.width*$(i),r]}:function(t,e,n){var i=n.east-n.west,a=n.width/$(i)*360/(2*Math.PI),r=a/2*Math.log((1+Math.sin(n.south))/(1-Math.sin(n.south))),o=(n.height+r-e)/a,s=180/Math.PI*(2*Math.atan(Math.exp(o))-Math.PI/2);return[$(n.west)+t/n.width*$(i),s]};var O,q=function(t){return Math.log(Math.tan(t/2+Math.PI/4))},k=function(t,e,n){var i=q(n.south),a=q(n.north),r=n.width/(n.east-n.west),o=n.height/(a-i),s=q(R(t));return[(R(e)-n.west)*r,s=(a-s)*o]},G=function(u,c,d,n){var l=function(t){var e=document.createElement("canvas"),a=t.width,n=t.height;e.width=a,e.height=n;var i=e.getContext("2d");i.fillStyle="rgba(255, 0, 0, 1)",i.fill();var r=i.getImageData(0,0,a,n),o=r.data;return{imageData:r,isVisible:function(t,e){return 0<o[4*(e*a+t)+3]},set:function(t,e,n){var i=4*(e*a+t);return o[i]=n[0],o[i+1]=n[1],o[i+2]=n[2],o[i+3]=n[3],this}}}(c),f={},t=(d.south-d.north)*(d.west-d.east),p=e*Math.pow(t,.4),v=[],i=c.x;function a(t){for(var e=[],n=c.y;n<=c.yMax;n+=2){var i=A(t,n,d),a=[0,0,0,0];if(i){var r=i[0],o=i[1];if(isFinite(r)){var s=u.interpolate(r,o),h=null;s&&(z?(s=B(f,r,o,t,n,p,s,d),e[n+1]=e[n]=s):h=s),I(h)&&(a=j(W)(h,M))}}l.set(t,n,a).set(t+1,n,a).set(t,n+1,a).set(t+1,n+1,a)}v[t+1]=v[t]=e}!function t(){for(var e=Date.now();i<c.width;)if(a(i),i+=2,1e3<Date.now()-e)return void setTimeout(t,25);T(v,c,l,n)}()},V=function(i,s){var e,n,h=(e=d,n=l,D.indexFor=function(t){return Math.max(0,Math.min(D.length-1,Math.round((t-e)/(n-e)*(D.length-1))))},D),u=h.map(function(){return[]}),t=Math.round(i.width*i.height*b);/android|blackberry|iemobile|ipad|iphone|ipod|opera mini|webos/i.test(navigator.userAgent)&&(t*=C);for(var a=[],r=0;r<t;r++)a.push(s.randomize({age:Math.floor(Math.random()*x)+0}));var o=f.canvas.getContext("2d");o.lineWidth=_,o.fillStyle="rgba(0, 0, 0, 0.97)",o.globalAlpha=.6;var c=Date.now();!function t(){O=requestAnimationFrame(t);var e=Date.now(),n=e-c;E<n&&(c=e-n%E,u.forEach(function(t){t.length=0}),a.forEach(function(t){t.age>x&&(s.randomize(t).age=0);var e=t.x,n=t.y,i=s(e,n),a=i[2];if(null===a)t.age=x;else{var r=e+i[0],o=n+i[1];null!==s(r,o)[2]?(t.xt=r,t.yt=o,u[h.indexFor(a)].push(t)):(t.x=r,t.y=o)}t.age+=1}),o.globalCompositeOperation="destination-in",o.fillRect(i.x,i.y,i.width,i.height),o.globalCompositeOperation="lighter",o.globalAlpha=.9,u.forEach(function(t,e){0<t.length&&(o.beginPath(),o.strokeStyle=h[e],t.forEach(function(t){o.moveTo(t.x,t.y),o.lineTo(t.xt,t.yt),t.x=t.xt,t.y=t.yt}),o.stroke())}))}()},U=function(e,n,i,t){var a={south:R(t[0][1]),north:R(t[1][1]),east:R(t[1][0]),west:R(t[0][0]),width:n,height:i};H(),function(t,e){var n=(p=P(t)).header;g=n.lo1,w=Math.max(n.la2,n.la1),m=n.dx,y=n.dy,u=n.nx,c=n.ny,(h=new Date(n.refTime)).setHours(h.getHours()+n.forecastTime),v=[];for(var i=0,a=360<=Math.floor(u*m),r=0;r<c;r++){for(var o=[],s=0;s<u;s++,i++)o[s]=p.data(i);a&&o.push(o[0]),v[r]=o}e({date:h,interpolate:S})}(r,function(t){G(t,function(t,e,n){var i=t[0],a=t[1],r=Math.round(i[0]),o=Math.max(Math.floor(i[1],0),0);Math.min(Math.ceil(a[0],e),e-1);return{x:r,y:o,xMax:e,yMax:Math.min(Math.ceil(a[1],n),n-1),width:e,height:n}}(e,n,i),a,function(t,e){Z.field=e,z?V(t,e):function(t,e){if(e){var n=f.canvas,i=n.width,a=n.height,r=n.getContext("2d");r.clearRect(0,0,i,a),r.putImageData(e.overlay,0,0)}}(0,e)})})},H=function(){Z.field&&Z.field.release(),O&&cancelAnimationFrame(O)},Z={params:f,start:U,stop:H,update:function(t,e,n,i,a){delete f.data,f.data=t,a&&U(e,n,i,a)},shift:function(t,e){var n=f.canvas,i=n.width,a=n.height,r=n.getContext("2d");if(t<i&&e<a){var o=function(t,e){return Math.max(0,Math.min(t,e))},s=r.getImageData(o(i,-t),o(a,-e),o(i,i-t),o(a,a-e));r.clearRect(0,0,i,a),r.putImageData(s,o(i,t),o(a,e));for(var h=0,u=particles.length;h<u;h++)particles[h].x+=t,particles[h].y+=e}},createField:T,interpolatePoint:S,setData:function(t){r=t}};return Z};window.requestAnimationFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(t){return window.setTimeout(t,1e3/FRAME_RATE)},window.cancelAnimationFrame||(window.cancelAnimationFrame=function(t){clearTimeout(t)});var o=function(t,e,n){if("undefined"!=typeof document){var i=document.createElement("canvas");return i.width=t,i.height=e,i}return new n(t,e)},s=function(t,e,n){n.endsWith("CCW")&&(e=0<e?e=-e:Math.abs(e));var i=Math.sqrt(Math.pow(t,2)+Math.pow(e,2)),a=180*Math.atan2(t/i,e/i)/Math.PI+180;return"bearingCW"!==n&&"meteoCCW"!==n||360<=(a+=180)&&(a-=360),a},h=function(t,e,n){var i=Math.sqrt(Math.pow(t,2)+Math.pow(e,2));return"k/h"===n?c(i):"kt"===n?u(i):i},u=function(t){return t/.514},c=function(t){return 3.6*t},d=("undefined"==typeof window?{}:window).ol||{};d.layer||(d.layer={}),d.layer.Image||(d.layer.Image=function(){});var t=function(i){function t(t,e){var n;return void 0===e&&(e={}),(n=i.call(this,e)||this)._canvas=null,n.data=t,n.$Windy=null,n.isClear=!1,n.options=e,n.setSource(new d.source.ImageCanvas({logo:e.logo,state:e.state,attributions:e.attributions,resolutions:e.resolutions,canvasFunction:n.canvasFunction.bind(a(n)),projection:e.hasOwnProperty("projection")?e.projection:"EPSG:3857",ratio:e.hasOwnProperty("ratio")?e.ratio:1})),n.on("precompose",n.redraw,a(n)),n}n(t,i);var e=t.prototype;return e.getData=function(){return this.data},e.setData=function(t){var e=this.getMap();if(!e)return this;if(this.data=t,this.isClear=!1,!this.$Windy&&this._canvas)this.render(this._canvas),e.renderSync();else if(this.$Windy&&this._canvas){this._cloneLayer&&(e.addLayer(this._cloneLayer),delete this._cloneLayer);var n=this._getExtent();this.$Windy.update(this.getData(),n[0],n[1],n[2],n[3])}else console.warn("please create new instance");return this},e.render=function(t){var e=this._getExtent();if(this.isClear||!this.getData()||!e)return this;if(t&&!this.$Windy)this.$Windy=new r({canvas:t,projection:this.get("projection"),data:this.getData()}),this.$Windy.start(e[0],e[1],e[2],e[3]);else if(t&&this.$Windy){var n=this._getExtent();this.$Windy.start(n[0],n[1],n[2],n[3])}return this},e.redraw=function(){if(!this.isClear){var t=this.options.extent||this._getMapExtent();this.setExtent(t)}},e.canvasFunction=function(t,e,n,i,a){return this._canvas?(this._canvas.width=i[0],this._canvas.height=i[1]):this._canvas=o(i[0],i[1]),e<=this.get("maxResolution")&&this.render(this._canvas),this._canvas},e._getExtent=function(){var t=this._getMapSize(),e=this._getMapExtent();if(t&&e){var n=this.get("projection"),i=d.proj.transformExtent(e,n,"EPSG:4326");return[[[0,0],[t[0],t[1]]],t[0],t[1],[[i[0],i[1]],[i[2],i[3]]]]}return!1},e._getMapExtent=function(){if(this.getMap()){var t=this._getMapSize(),e=this.getMap().getView();return e&&e.calculateExtent(t)}},e._getMapSize=function(){if(this.getMap())return this.getMap().getSize()},e.appendTo=function(t){if(!(t&&t instanceof d.Map))throw new Error("not map object");this.set("originMap",t),t.addLayer(this)},e.getPointData=function(t){var e=this.$Windy.interpolatePoint(t[0],t[1]);if(e&&!isNaN(e[0])&&!isNaN(e[1])&&e[2])return{direction:s(e[0],e[1],this.options.angleConvention||"bearingCCW"),speed:h(e[0],e[1],this.options.speedUnit)}},e.clearWind=function(){var t=this.getMap();t&&(this.$Windy&&this.$Windy.stop(),this.isClear=!0,this._cloneLayer=this,t.removeLayer(this),this.changed(),this.getMap().renderSync())},e.removeLayer=function(){var t=this.getMap();t&&(this.$Windy&&this.$Windy.stop(),this.un("precompose",this.redraw,this),t.removeLayer(this),delete this._canvas,delete this.$Windy,delete this._cloneLayer)},e.setMap=function(t){this.set("originMap",t)},e.getMap=function(){return this.get("originMap")},t}(d.layer.Image),i=("undefined"==typeof window?{}:window).AMap||{},e=function(){function t(t,e){void 0===e&&(e={}),this.options=e,this.canvas=null,this.data=t,this.layer_=null,this._windy=null,e.map&&this.appendTo(e.map)}var e=t.prototype;return e.appendTo=function(t){var e=this;if(!t)throw new Error("not map object");t.on("complete",function(){e.init(t)},this)},e.getData=function(){return this.data},e.setData=function(t){this.data=t,this.map&&this.canvas&&this.data&&this.render()},e.init=function(t,e){if(!t)throw new Error("not map object");this.map=t,this.context=this.options.context||"2d",this.getCanvasLayer()},e.render=function(t){if(t){var e=this._getExtent();return this.getData()&&e&&(t&&!this._windy?(this._windy=new r({canvas:t,data:this.getData(),onDraw:function(){}}),this._windy.start(e[0],e[1],e[2],e[3])):t&&this._windy&&this._windy.start(e[0],e[1],e[2],e[3])),this}},e.getCanvasLayer=function(){if(!this.canvas&&!this.layer_){var t=this.canvasFunction(),e=this.map.getBounds();this.layer_=new i.CanvasLayer({canvas:t,bounds:this.options.bounds||e,zooms:this.options.zooms||[0,22]}),this.map.on("mapmove",this.canvasFunction,this),this.map.on("zoomchange",this.canvasFunction,this),this.layer_.setMap(this.map)}},e.canvasFunction=function(){var t=[this.map.getSize().width,this.map.getSize().height],e=t[0],n=t[1];if(this.canvas){this.canvas.width=e,this.canvas.height=n;var i=this.map.getBounds();this.layer_&&this.layer_.setBounds(this.options.bounds||i)}else this.canvas=o(e,n,null);return this.render(this.canvas),this.canvas},e._getExtent=function(){var t=[this.map.getSize().width,this.map.getSize().height],e=t[0],n=t[1],i=this.map.getBounds().getNorthEast(),a=this.map.getBounds().getSouthWest();return[[[0,0],[e,n]],e,n,[[i.lng,i.lat],[a.lng,a.lat]]]},e.removeLayer=function(){this.map&&(this.map.removeLayer(this.layer_),delete this.map,delete this.layer_,delete this.canvas)},e.getContext=function(){return this.canvas.getContext(this.context)},e.getPointData=function(t){var e=this._windy.interpolatePoint(t[0],t[1]);if(e&&!isNaN(e[0])&&!isNaN(e[1])&&e[2])return{direction:s(e[0],e[1],this.options.angleConvention||"bearingCCW"),speed:h(e[0],e[1],this.options.speedUnit)}},e.clearWind=function(){this._windy&&this._windy.stop()},t}(),l="undefined"==typeof window?{}:window;return l.BMap||(l.BMap={}),l.BMap.Overlay||(l.BMap.Overlay=function(){}),{AMapWind:e,BMapWind:function(i){function t(t,e){var n;return void 0===e&&(e={}),(n=i.call(this,e)||this).options=e,n.paneName=n.options.paneName||"mapPane",n.context=n.options.context||"2d",n.zIndex=n.options.zIndex||0,n.mixBlendMode=n.options.mixBlendMode||null,n.enableMassClear=n.options.enableMassClear,n._map=e.map,n._lastDrawTime=null,n.canvas=null,n.data=t,n._windy=null,n.show(),n}n(t,i);var e=t.prototype;return e.getData=function(){return this.data},e.setData=function(t){this.data=t,this._map&&this.data&&this._draw()},e._getExtent=function(){var t=this._map.getSize(),e=this._map.getBounds().getNorthEast(),n=this._map.getBounds().getSouthWest();return[[[0,0],[t.width,t.height]],t.width,t.height,[[e.lng,e.lat],[n.lng,n.lat]]]},e.appendTo=function(t){if(!t)throw new Error("not map object");t.addOverlay(this)},e.initialize=function(t){var e=this;this._map=t;var n=this.canvas=document.createElement("canvas");return n.style.cssText="position:absolute; left:0; top:0; z-index: "+this.zIndex+" ;user-select:none;",n.style.mixBlendMode=this.mixBlendMode,this.adjustSize(),t.getPanes()[this.paneName].appendChild(n),t.addEventListener("resize",function(){e.adjustSize(),e._draw()}),this.canvas},e.adjustSize=function(){var t=this._map.getSize(),e=this.canvas,n=this.devicePixelRatio=l.devicePixelRatio||1;e.width=t.width*n,e.height=t.height*n,"2d"===this.context&&e.getContext(this.context).scale(n,n),e.style.width=t.width+"px",e.style.height=t.height+"px"},e.draw=function(){var t=this;clearTimeout(t.timeoutID),t.timeoutID=setTimeout(function(){t._draw()},15)},e._draw=function(){var t=this._map,e=t.getSize(),n=t.getCenter();if(n){var i=t.pointToOverlayPixel(n);this.canvas.style.left=i.x-e.width/2+"px",this.canvas.style.top=i.y-e.height/2+"px",this.dispatchEvent("draw"),this.options.update&&this.options.update.call(this),this.render(this.canvas)}},e.render=function(t){var e=this._getExtent();return this.getData()&&e&&(t&&!this._windy?(this._windy=new r({canvas:t,data:this.getData(),onDraw:function(){}}),this._windy.start(e[0],e[1],e[2],e[3])):t&&this._windy&&this._windy.start(e[0],e[1],e[2],e[3])),this},e.getContainer=function(){return this.canvas},e.setZIndex=function(t){this.zIndex=t,this.canvas.style.zIndex=this.zIndex},e.getZIndex=function(){return this.zIndex},e.getPointData=function(t){var e=this._windy.interpolatePoint(t[0],t[1]);if(e&&!isNaN(e[0])&&!isNaN(e[1])&&e[2])return{direction:s(e[0],e[1],this.options.angleConvention||"bearingCCW"),speed:h(e[0],e[1],this.options.speedUnit)}},e.clearWind=function(){this._windy&&this._windy.stop()},t}(l.BMap.Overlay),OlWind:t}});