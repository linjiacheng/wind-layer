!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e(require("maptalks")):"function"==typeof define&&define.amd?define(["maptalks"],e):(t=t||self).windLayer=e(t.maptalks)}(this,function(a){"use strict";function o(h){void 0===h&&(h={}),this.params=h;var S=this;function e(t){t.projection||(t.projection="EPSG:4326"),S.MIN_VELOCITY_INTENSITY=t.minVelocity||0,S.MAX_VELOCITY_INTENSITY=t.maxVelocity||10,S.VELOCITY_SCALE=(t.velocityScale||.005)*(Math.pow(window.devicePixelRatio,1/3)||1),S.MAX_PARTICLE_AGE=t.particleAge||90,S.PARTICLE_LINE_WIDTH=t.lineWidth||1,S.PARTICLE_MULTIPLIER=t.particleMultiplier||1/300,S.PARTICLE_REDUCTION=Math.pow(window.devicePixelRatio,1/3)||1.6,S.FRAME_RATE=t.frameRate||16,S.COLOR_SCALE=t.colorScale||a,S.OVERLAY_COLOR_SCALE=t.overlayColorScale||n,S.OVERLAY_ALPHA=Math.floor(153)}S.canvas=h.canvas;var a=["rgb(36,104, 180)","rgb(60,157, 194)","rgb(128,205,193 )","rgb(151,218,168 )","rgb(198,231,181)","rgb(238,247,217)","rgb(255,238,159)","rgb(252,217,125)","rgb(255,182,100)","rgb(252,150,75)","rgb(250,112,52)","rgb(245,64,32)","rgb(237,45,28)","rgb(220,24,32)","rgb(180,0,35)"],n=[[193,[37,4,42]],[206,[41,10,130]],[219,[81,40,40]],[233.15,[192,37,149]],[255.372,[70,215,215]],[273.15,[21,84,187]],[275.15,[24,132,14]],[291,[247,251,59]],[298,[235,167,21]],[311,[230,71,39]],[328,[88,27,67]]];function r(t,e,a,n,r,o){var i=1-t,c=1-e;return a*i*c+n*t*c+r*i*e+o*t*e}function o(t,e,a,n,r,o){var i=1-t,c=1-e,u=i*c,l=t*c,s=i*e,h=t*e,p=a[0]*u+n[0]*l+r[0]*s+o[0]*h,f=a[1]*u+n[1]*l+r[1]*s+o[1]*h;return[p,f,Math.sqrt(p*p+f*f)]}function u(t){var e=null,a=null,n=null;return t.forEach(function(t){switch(t.header.parameterCategory+","+t.header.parameterNumber){case"1,2":case"2,2":e=t;break;case"1,3":case"2,3":a=t;break;default:n=t}}),null!=n?function(t){L=!1;var e=t.data;return{header:t.header,interpolate:r,data:function(t){return e[t]}}}(n):function(t,e){L=!0;var a=t.data,n=e.data;return{header:t.header,data:function(t){return[a[t],n[t]]},interpolate:o}}(e,a)}e(h),window.FRAME_TIME=1e3/S.FRAME_RATE;var f,d,l,m,g,y,v,s,p,i=[NaN,NaN,null],c=S.params.data,L=!0,M=function(t,e){if(!d)return null;var a,n=w(t-m,360)/y,r=(g-e)/v,o=Math.floor(n),i=o+1,c=Math.floor(r),u=c+1;if(a=d[c]){var l=a[o],s=a[i];if(C(l)&&C(s)&&(a=d[u])){var h=a[o],p=a[i];if(C(h)&&C(p))return f.interpolate(n-o,r-c,l,s,h,p)}}return null},C=function(t){return null!=t},w=function(t,e){return t-e*Math.floor(t/e)},_=function(t,e,a){return(function(t,e){return Math.max(e[0],Math.min(t,e[1]))}(t,[e,a])-e)/(a-e)},E=function(t,e){var a=t[0],n=t[1],r=t[2],o=e[0]-a,i=e[1]-n,c=e[2]-r;return function(t,e){return[Math.floor(a+t*o),Math.floor(n+t*i),Math.floor(r+t*c),e]}};function T(t){for(var r=[],o=[],i=[],e=0;e<t.length-1;e++)r.push(t[e+1][0]),o.push(E(t[e][1],t[e+1][1])),i.push([t[e][0],t[e+1][0]]);return function(t,e){var a;for(a=0;a<r.length-1&&!(t<=r[a]);a++);var n=i[a];return o[a](_(t,n[0],n[1]),e)}}function P(n,r,t,e){function o(t,e){var a=n[Math.round(t)];return a&&a[Math.round(e)]||i}o.release=function(){n=[]},o.randomize=function(t){for(var e,a,n=0;null===o(e=Math.round(Math.floor(Math.random()*r.width)+r.x),a=Math.round(Math.floor(Math.random()*r.height)+r.y))[2]&&n++<30;);return t.x=e,t.y=a,t},o.overlay=t.imageData,e(r,o)}function A(t){return t/180*Math.PI}function R(t){return t/(Math.PI/180)}var b,O=function(t,e,a,n,r,o){var i=2*Math.PI,c="EPSG:4326"===S.params.projection?5:Math.pow(10,-5.2),u=e<0?c:-c,l=a<0?c:-c,s=N(a,e+u,o),h=N(a+l,e,o),p=Math.cos(a/360*i);return[(s[0]-n)/u/p,(s[1]-r)/u/p,(h[0]-n)/l,(h[1]-r)/l]};function x(t){return Math.log(Math.tan(t/2+Math.PI/4))}function I(w,_,E,a){var A=function(t){var e=document.createElement("canvas"),r=t.width,a=t.height;e.width=r,e.height=a;var n=e.getContext("2d");n.fillStyle="rgba(255, 0, 0, 1)",n.fill();var o=n.getImageData(0,0,r,a),i=o.data;return{imageData:o,isVisible:function(t,e){return 0<i[3+4*(e*r+t)]},set:function(t,e,a){var n=4*(e*r+t);return i[n]=a[0],i[1+n]=a[1],i[2+n]=a[2],i[3+n]=a[3],this}}}(_),R={},t=(E.south-E.north)*(E.west-E.east),x=S.VELOCITY_SCALE*Math.pow(t,.4),I=[],n=_.x;function r(t){for(var e,a,n,r,o,i,c,u,l,s,h,p=[],f=_.y;f<=_.yMax;f+=2){var d=b(t,f,E),m=[0,0,0,0];if(d){var g=d[0],y=d[1];if(isFinite(g)){var v=w.interpolate(g,y),M=null;v&&(L?(e=R,a=g,n=y,r=t,o=f,i=x,u=E,void 0,l=(c=v)[0]*i,s=c[1]*i,h=O(e,a,n,r,o,u),c[0]=h[0]*l+h[2]*s,c[1]=h[1]*l+h[3]*s,v=c,p[f+1]=p[f]=v):M=v),C(M)&&(m=T(S.OVERLAY_COLOR_SCALE)(M,OVERLAY_ALPHA))}}A.set(t,f,m).set(t+1,f,m).set(t,f+1,m).set(t+1,f+1,m)}I[t+1]=I[t]=p}!function t(){for(var e=Date.now();n<_.width;)if(r(n),n+=2,1e3<Date.now()-e)return void setTimeout(t,25);P(I,_,A,a)}()}function D(n,c){var e,a,u=(e=S.MIN_VELOCITY_INTENSITY,a=S.MAX_VELOCITY_INTENSITY,S.COLOR_SCALE.indexFor=function(t){return Math.max(0,Math.min(S.COLOR_SCALE.length-1,Math.round((t-e)/(a-e)*(S.COLOR_SCALE.length-1))))},S.COLOR_SCALE),l=u.map(function(){return[]}),t=Math.round(n.width*n.height*S.PARTICLE_MULTIPLIER);/android|blackberry|iemobile|ipad|iphone|ipod|opera mini|webos/i.test(navigator.userAgent)&&(t*=S.PARTICLE_REDUCTION);for(var r=[],o=0;o<t;o++)r.push(c.randomize({age:Math.floor(Math.random()*S.MAX_PARTICLE_AGE)+0}));var i=S.canvas.getContext("2d");i.lineWidth=S.PARTICLE_LINE_WIDTH,i.fillStyle="rgba(0, 0, 0, 0.97)",i.globalAlpha=.6;var s=Date.now();!function t(){V=requestAnimationFrame(t);var e=Date.now(),a=e-s;a>FRAME_TIME&&(s=e-a%FRAME_TIME,l.forEach(function(t){t.length=0}),r.forEach(function(t){t.age>S.MAX_PARTICLE_AGE&&(c.randomize(t).age=0);var e=t.x,a=t.y,n=c(e,a),r=n[2];if(null===r)t.age=S.MAX_PARTICLE_AGE;else{var o=e+n[0],i=a+n[1];null!==c(o,i)[2]?(t.xt=o,t.yt=i,l[u.indexFor(r)].push(t)):(t.x=o,t.y=i)}t.age+=1}),i.globalCompositeOperation="destination-in",i.fillRect(n.x,n.y,n.width,n.height),i.globalCompositeOperation="lighter",i.globalAlpha=.9,l.forEach(function(t,e){0<t.length&&(i.beginPath(),i.strokeStyle=u[e],t.forEach(function(t){i.moveTo(t.x,t.y),i.lineTo(t.xt,t.yt),t.x=t.xt,t.y=t.yt}),i.stroke())}),h.onDraw&&h.onDraw())}()}b="EPSG:4326"===S.params.projection?function(t,e,a){var n=a.east-a.west,r=a.south-a.north,o=R(a.north)+e/a.height*R(r);return[R(a.west)+t/a.width*R(n),o]}:function(t,e,a){var n=a.east-a.west,r=a.width/R(n)*360/(2*Math.PI),o=r/2*Math.log((1+Math.sin(a.south))/(1-Math.sin(a.south))),i=(a.height+o-e)/r,c=180/Math.PI*(2*Math.atan(Math.exp(i))-Math.PI/2);return[R(a.west)+t/a.width*R(n),c]};var V,N=function(t,e,a){var n=x(a.south),r=x(a.north),o=a.width/(a.east-a.west),i=a.height/(r-n),c=x(A(t));return[(A(e)-a.west)*o,c=(r-c)*i]},F=function(e,a,n,t){var r={south:A(t[0][1]),north:A(t[1][1]),east:A(t[1][0]),west:A(t[0][0]),width:a,height:n};Y(),function(t,e){var a=(f=u(t)).header;m=a.lo1,g=Math.max(a.la2,a.la1),y=a.dx,v=a.dy,s=a.nx,p=a.ny,(l=new Date(a.refTime)).setHours(l.getHours()+a.forecastTime),d=[];for(var n=0,r=360<=Math.floor(s*y),o=0;o<p;o++){for(var i=[],c=0;c<s;c++,n++)i[c]=f.data(n);r&&i.push(i[0]),d[o]=i}e({date:l,interpolate:M})}(c,function(t){I(t,function(t,e,a){var n=t[0],r=t[1],o=Math.round(n[0]),i=Math.max(Math.floor(n[1],0),0);Math.min(Math.ceil(r[0],e),e-1);return{x:o,y:i,xMax:e,yMax:Math.min(Math.ceil(r[1],a),a-1),width:e,height:a}}(e,a,n),r,function(t,e){W.field=e,L?D(t,e):function(t,e){if(e){var a=h.canvas,n=a.width,r=a.height,o=a.getContext("2d");o.clearRect(0,0,n,r),o.putImageData(e.overlay,0,0)}}(0,e)})})},Y=function(){W.field&&W.field.release(),V&&cancelAnimationFrame(V)},W={params:S.params,start:F,stop:Y,update:function(t,e,a,n,r){delete S.params.data,S.params.data=t,r&&F(e,a,n,r)},shift:function(t,e){var a=S.canvas,n=a.width,r=a.height,o=a.getContext("2d");if(t<n&&e<r){var i=function(t,e){return Math.max(0,Math.min(t,e))},c=o.getImageData(i(n,-t),i(r,-e),i(n,n-t),i(r,r-e));o.clearRect(0,0,n,r),o.putImageData(c,i(n,t),i(r,e));for(var u=0,l=particles.length;u<l;u++)particles[u].x+=t,particles[u].y+=e}},createField:P,interpolatePoint:M,setData:function(t){c=t},updateParams:function(t){S.params=t,e(S.params)},getParams:function(){return S.params},buildParams:e};return W}window.requestAnimationFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(t){return window.setTimeout(t,1e3/window.FRAME_RATE)},window.cancelAnimationFrame||(window.cancelAnimationFrame=function(t){clearTimeout(t)});var r={minVelocity:0,maxVelocity:10,velocityScale:.05,particleAge:90,lineWidth:1,particleMultiplier:1/300,colorScale:void 0,animate:!0},t=function(e){function t(){e.apply(this,arguments)}return e&&(t.__proto__=e),((t.prototype=Object.create(e&&e.prototype)).constructor=t).prototype._initialize=function(){var t=this,e=this.getMap(),a=this.layer.getParams(),n=this.layer.getSpatialReference(),r=(n=n||e.getSpatialReference()).getProjection();this._windy=new o(Object.assign({},{canvas:this.canvas,data:this.layer.getData(),projection:r.code||"EPSG:4326",onDraw:function(){t.setCanvasUpdated()}},a))},t.prototype.draw=function(){var t,e=this._getWindExtents();this.prepareCanvas(),this._windy||this._initialize(),this._windy&&(t=this._windy).start.apply(t,e)},t.prototype._redraw=function(){this.prepareRender(),this.draw()},t.prototype.drawOnInteracting=function(){},t.prototype._getWindExtents=function(){var t=this.getMap();if(!t)return null;var e=t.getExtent(),a=e.xmin,n=0<e.xmax?e.xmax:360+e.xmax,r=e.ymin,o=e.ymax;return[[[0,0],[t.width,t.height]],t.width,t.height,[[a,r],[n,o]]]},t.prototype._updateParams=function(){if(this._windy){var t=this.layer.getParams();this._windy.updateParams(t),this.draw()}},t.prototype.needToRedraw=function(){var t=this.getMap();return!(t.isZooming()&&!t.getPitch())&&e.prototype.needToRedraw.call(this)},t.prototype.onZoomStart=function(){e.prototype.onZoomStart.apply(this,arguments)},t.prototype.onZoomEnd=function(){e.prototype.onZoomEnd.apply(this,arguments)},t.prototype.onDragRotateStart=function(){},t.prototype.onMoveStart=function(){},t.prototype.remove=function(){this._windy&&(this._windy.stop(),delete this._windy),e.prototype.remove.call(this)},t}(a.renderer.CanvasRenderer),e=function(n){function e(t,e,a){n.call(this,t,Object.assign(r,a)),this._data=e}return n&&(e.__proto__=n),((e.prototype=Object.create(n&&n.prototype)).constructor=e).prototype.getData=function(){return this._data},e.prototype.setData=function(t){return this._data=t,this.redraw(),this},e.prototype.updateParams=function(t){var e=this._getRenderer();if(this.options=Object.assign(this.options,t),e){var a=this.options,n=a.minVelocity,r=a.maxVelocity,o=a.velocityScale,i=a.particleAge,c=a.lineWidth,u=a.particleMultiplier,l=a.colorScale;e._updateParams({minVelocity:n,maxVelocity:r,velocityScale:o,particleAge:i,lineWidth:c,particleMultiplier:u,colorScale:l})}return this},e.prototype.getParams=function(){var t=this.options;return{minVelocity:t.minVelocity,maxVelocity:t.maxVelocity,velocityScale:t.velocityScale,particleAge:t.particleAge,lineWidth:t.lineWidth,particleMultiplier:t.particleMultiplier,colorScale:t.colorScale}},e.prototype.onResize=function(){},e.prototype.onZoomStart=function(){},e.prototype.onZooming=function(){},e.prototype.onZoomEnd=function(){},e.prototype.onMoveStart=function(){},e.prototype.onMoving=function(){},e.prototype.onMoveEnd=function(){},e.prototype.redraw=function(){var t=this._getRenderer();return t&&t._redraw(),this},e.prototype.toJSON=function(){return{type:"MaptalksWindy",id:this.getId(),options:this.config(),data:this.getData()}},e.prototype.getSpatialReference=function(){var t=this.getMap();return!t||this.options.spatialReference&&!a.SpatialReference.equals(this.options.spatialReference,t.options.spatialReference)?(this._sr=this._sr||new a.SpatialReference(this.options.spatialReference),this._sr):t.getSpatialReference()},e.fromJSON=function(t){return t&&"MaptalksWindy"===t.type?new e(t.id,t.data,t.options):null},e}(a.Layer);return e.registerRenderer("canvas",t),e});
